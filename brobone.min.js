!function(a,b){var a="object"==typeof self&&self.self==self&&self||"object"==typeof global&&global.global==global&&global;if("function"==typeof define&&define.amd)define(["backbone","underscore","handlebars"],function(c,d,e){return a.Brobone=b(a,c,d,e)});else if("undefined"!=typeof exports){var c=require("backbone"),d=require("underscore"),e=require("handlebars");module.exports=b(a,c,d,e)}else a.Brobone=b(a,a.Backbone,a._,a.Handlebars)}(this,function(a,b,c,d){"use strict";var e=a.Brobone,f=b.Brobone={};return f.VERSION="0.0.1",f.noConflict=function(){return a.Brobone=e,this},f._triggerMethod=function(){function a(a,b,c){return c.toUpperCase()}var b=/(^|:)(\w)/gi;return function(d,e,f){var g=arguments.length<3;g&&(f=e,e=f[0]);var h,i="on"+e.replace(b,a),j=d[i];return c.isFunction(j)&&(h=j.apply(d,g?c.rest(f):f)),c.isFunction(d.trigger)&&(g+f.length>1?d.trigger.apply(d,g?f:[e].concat(c.drop(f,0))):d.trigger(e)),h}}(),f.triggerMethod=function(a){return f._triggerMethod(this,arguments)},f.Object=function(a){this.options=c.extend({},c.result(this,"options"),a),this.initialize.apply(this,arguments)},f.Object.extend=b.Model.extend,c.extend(f.Object.prototype,b.Events,{initialize:function(){},destroy:function(a){if(a||(a={}),!a.keepAlive)return this.triggerMethod("before:destroy"),this.stopListening(),this.undelegateEvents(),this.triggerMethod("destroy"),this},triggerMethod:f.triggerMethod}),f.Router=b.Router.extend({routePattern:":controller/:action(/)(:id)",constructor:function(a){if(a||(a={}),a.routePattern&&(this.routePattern=a.routePattern),this.Routing={},this.listenTo(f.controllerManager,"customRouting",this.bindRoutes),this.on("route",this.trackHistory),!this.checkRouterPattern())throw Error("routerPattern not correct. It has to contain ':controller' and ':action' keywords");this.route(this.routePattern),this.Routing.route=this._routeToRegExp(this.routePattern)},checkRouterPattern:function(){var a=this.routePattern.replace(/[^\w\s:\/]/gi,"").split("/");return this.Routing.Index={controller:a.indexOf(":controller"),action:a.indexOf(":action")},this.Routing.Index.controller>-1&&this.Routing.Index.controller===a.lastIndexOf(":controller")&&this.Routing.Index.action>-1&&this.Routing.Index.action===a.lastIndexOf(":action")},route:function(a,d){c.isRegExp(a)||(a=this._routeToRegExp(a));var e=this;return b.history.route(a,function(b){var c=e._extractParameters(a,b);e.execute(a,c,b)!==!1&&d&&(e.trigger.apply(e,["route:"+d].concat(c)),e.trigger("route",d,c))}),this},execute:function(a,b,c){f.controllerManager.processRouting(a,b,this.Routing.Index,this.Routing.route.source!=a.source)},start:function(a){a||(a={}),a.startRoute&&(this.startRoute=a.startRoute),this.navigate(this.startRoute,{trigger:!0})},trackHistory:function(a,c){this.prevPage=this.currentPage,this.currentPage={name:a,args:c,hash:b.history.fragment}},bindRoutes:function(a){for(var b,d=c.keys(a);null!=(b=d.pop());)this.route(b,a[b])}}),f.Application=f.Object.extend({constructor:function(a){this.options=c.extend({},c.result(this,"options"),a),f.controllerManager=new f.ControllerManager,f.mainRouter=new f.Router(this.options)},registerController:function(a){if(!a||!a.controller||!a.name||"string"!=typeof a.name)throw Error("cannot register controller "+a.name);a.controller.prototype instanceof f.Controller&&f.controllerManager.add(a)},start:function(a){this.options=c.extend({},c.result(this,"options"),a),this.triggerMethod("before:start"),b.history.start(a),f.mainRouter.start(a),this.triggerMethod("start")},removeController:function(a){if(!a||!a.controller||!a.name||"string"!=typeof a.name)throw Error("cannot remove controller "+a.name);a.controller.prototype instanceof f.Controller&&f.controllerManager.remove(a)}}),f.Controller=f.Object.extend({constructor:function(a){a||(a={}),this._initalActionBuffer(),this._resolveActions(),this.listenTo(this,"execute",this._execute)},_initalActionBuffer:function(){this.actions={}},_execute:function(a,b){if(!a||!c.isFunction(this.actions[a]))throw"action is undefined or doesnt exist under this controller, action:"+a;this.triggerMethod("before:action"),this.actions[a].apply(this,b),this.triggerMethod("action")},_resolveActions:function(){for(var a in this)!c.isFunction(this[a])||a.lastIndexOf("_",0)!==-1||/destroy/i.test(a)&&/constructor/i.test(a)||(this.actions[a.toLowerCase()]=this[a])},destroy:function(a){if(a||(a={}),!a.keepAlive)return this.view&&this.view.destroy(),this.triggerMethod("before:destroy"),this.stopListening(),this.triggerMethod("destroy"),this}}),f.ControllerManager=f.Object.extend({initialize:function(){this.controllers={}},add:function(a){var b=this.controllers[a.name.toLowerCase()]={controller:a.controller,customRoutes:c.result(a,"customRoutes",!1),instance:!1};b.customRoutes&&this.trigger("customRouting",b.customRoutes)},remove:function(a){var b=this._getController(a);if(!b)throw Error("no controller with this name: "+a);return this._destroyControllerInstance(b.instance),this.controllers[a]},_getController:function(a){return a&&(a=a.toLowerCase()),c.result(this.controllers,a)},_getCurrentController:function(){for(var a in this.controllers)if(this.controllers[a].instance!==!1)return this.controllers[a];return!1},_getCustomRoutingController:function(a,b){for(var c in this.controllers)for(var d in this.controllers[c].customRoutes)if(a.test(d)){var c=this.controllers[c];return{controller:c,action:c.customRoutes[d]}}return!1},_destroyControllerInstance:function(a){return!!a&&(a.destroy.call(this),this)},_createControllerInstance:function(a){return a.instance=new a.controller({manager:this}),a.instance},processRouting:function(a,b,d,e){var f,g,h;if(e){var i=this._getCustomRoutingController(a,e,b);i&&(f=i.controller,g=i.action)}else{h=b[d.controller].toLowerCase(),g=b[d.action].toLowerCase(),b=c.without(b,h,g);var f=this._getController(h)}if(!f)throw Error("controller not found controller:"+h);if(f.instance)f.instance.trigger("execute",g,b);else{var j=this._getCurrentController();j&&this._destroyControllerInstance(j.instance);var k=this._createControllerInstance(f);this._setCurrentController(k),k.trigger("execute",g,b)}},_setCurrentController:function(a){this.currentController=a}}),f.Model=b.Model.extend({constructor:function(a){b.Collection.prototype.constructor.call(this,a),this.initMode()},initMode:function(){this.mode={pending:!!this.url(),ready:!this.url()}},setMode:function(a){this.mode={pending:a.pending,ready:a.ready}},fetch:function(a){return this.setMode({pending:!0,ready:!1}),b.Model.prototype.fetch.call(this,a)}}),f.Collection=b.Collection.extend({constructor:function(a){b.Collection.prototype.constructor.call(this,a),this.setDefaultQuery(),this.initMode(),this.on("reset",this.prepare),this.on("update",this.prepare),this.on("add",this.prepare),this.on("filter",this.beforeFilter),this.on("sort",this.beforeSort),this.on("page",this.beforePaging)},clientProcess:!0,fetch:function(a){a||(a={});var d=a.data||{};return a.useQuery===!0&&(d=c.extend(d,this.query)),this.setMode({pending:!0,ready:!1}),b.Collection.prototype.fetch.call(this,{data:$.param(d),reset:!0})},initMode:function(){this.url?this.mode={pending:!0,ready:!1}:this.mode={pending:!1,ready:!0}},setMode:function(a){this.mode={pending:a.pending,ready:a.ready}},setDefaultQuery:function(){var a=this.defaultQuery||{};this.query={filter:a.filter||{properties:[],freeText:null},sort:a.sort||{rev:!1,sortBy:""},pager:a.pager||{pageSize:10,numberOfPages:0,current:1}}},setQuery:function(a){a||(a={}),this.query={filter:a.filter||this.query.filter,sort:a.sort||this.query.sort,pager:a.pager||this.query.pager},this.clientProcess&&this.process()},prepare:function(){this.setMode({pending:!1,ready:!0}),this.allModel=this.models,this.setQuery()},process:function(){var a=this.query,b=this.allModel||this.models;return b&&a&&(b=this.filter(b,a.filter),b=this.sort(b,a.sort),b=this.pagination(b,a.pager)),this.models=b,this.length=b.length,this.trigger("ready"),this},beforeFilter:function(a,b){if(b&&a){var d=this.query.filter;switch(a){case"prop":d.properties||(d.properties=[]),d.properties=c.filter(d.properties,function(a){return a.name!=b.name}),d.properties.push(b);break;case"text":d.freeText=b.text}this.setQuery({filter:d})}},filter:function(a,d){if(d&&d.properties){d.properties=c.filter(d.properties,function(a){return""!==a.value&&null!==a.value});var e=c.object(c.map(d.properties,c.values));a=new b.Collection(a).where(e)}if(d&&d.freeText){var f=this,g=d.freeText,h=[];c.each(f.searchProps,function(b){h.push.apply(h,c.filter(a,function(a){return a.attributes[b].toLowerCase().indexOf(g.toLowerCase())>-1}))}),h=c.uniq(h,function(a,b){return a.id}),a=h,this.trigger("filtered",d)}return a},beforeSort:function(a){if(a){var b={sortBy:a.sortBy,rev:a.changeDirection?!this.query.sort.rev:this.query.sort.rev,special:a.special};this.setQuery({sort:b})}},sort:function(a,b){return b&&(b.sortBy&&(a=c.sortBy(a,function(a){return a.attributes[b.sortBy]})),b.rev&&(a=a.reverse()),this.trigger("sorted",b)),a},pagination:function(a,b){var d=this.query.pager.numberOfPages;return this.query.pager.numberOfPages=a.length>b.pageSize?Math.round(a.length/b.pageSize):1,d!=this.query.pager.numberOfPages&&(this.query.pager.current=1),a=c.rest(a,b.pageSize*(b.current-1)),a=c.first(a,b.pageSize),this.trigger("paged",b),a},addWithoutTrigger:function(a,c){c||(c={}),c.silent=!0,b.Collection.prototype.add.call(this,a,c)}}),f.CompiledTemplates=f.CompiledTemplates||{},f.templateCache={get:function(a){return f.CompiledTemplates[a]},set:function(a,b){if(0==$(a).length)throw"template doesn't exist or not reachable. id: "+a;switch(b.toLowerCase()){case"handlebars":f.CompiledTemplates[a]=d.compile($(a).html());break;default:f.CompiledTemplates[a]=c.template($(a).html())}},getCached:function(a,b){return f.CompiledTemplates[a]||this.set(a,b),this.get(a)}},f.View=b.View.extend({triggerMethod:f.triggerMethod,constructor:function(a){this.type="BaseView",b.View.prototype.constructor.call(this,a),this.options=c.extend({},a,this.options),this.setOptions(),this.setSettings(),this.bindEvents()},defaultSettings:{templateCompiler:"handlebars"},setOptions:function(){for(var a in this.options)this[a]=this.options[a]},setSettings:function(){this.settings=c.extend({},this.defaultSettings,this.settings)},bindEvents:function(){this.parent&&this.listenTo(this.parent,"destroy:child",this.destroy)},render:function(){console.log("rendering "+this.cid+"type: ",this),this.triggerMethod("before:render");var a=this.mixinTemplateData(),b=this.compileTemplate(a);this.triggerMethod("render"),this.animateIn(b)},getTemplate:function(){if(!this.template)throw Error("template is missing");if("string"!=typeof this.template&&"function"!=typeof this.template)throw Error("template type is wrong");return this.template},compileTemplate:function(a){var b=this.getTemplate();if(!c.isFunction(b))var b=f.templateCache.getCached(b,this.settings.templateCompiler);return b(a)},mixinTemplateData:function(){var a=this.model?this.model.attributes:this.collection?this.collection:{};return this.templateHelpers&&(a=c.extend(a,c.isFunction(this.templateHelpers)?this.templateHelpers():this.templateHelpers)),a},animateIn:function(a){var b=this.settings.animationIn;b&&!c.isEmpty(b)?("function"==typeof b.callback&&(this.$el.hide().html(a),b.callback.apply(this.$el,b.args)),"string"==typeof b&&this.$el.addClass(b).html(a)):this.$el.html(a)},animateOut:function(){var a=this.settings.animationOut;a&&!c.isEmpty(a)?("function"==typeof a.callback&&(a.args.indexOf(this.emptyEl)===-1&&a.args.push(this.emptyEl),a.callback.apply(this.$el,a.args)),"string"==typeof a&&(this.$el.addClass(a),this.$el.on(a,function(){this.emptyEl()}))):this.emptyEl()},emptyEl:function(){var a=this.$el||$(this);a.empty()},destroy:function(){if(console.log("destroying "+this.cid+"type: ",this),!this.keepAlive||this.parent&&this.parent._isDestroyed)return this.triggerMethod("before:destroy"),this.triggerMethod("destroy:child"),this.unbindEvents(),this.animateOut(),this.triggerMethod("destroy"),this._isDestroyed=!0,this},unbindEvents:function(){this.stopListening(),this.undelegateEvents()}}),f.ItemView=f.View.extend({constructor:function(a){f.View.prototype.constructor.call(this,a),this.render()}}),f.ListItemView=f.View.extend({constructor:function(a){this.myEl=c.clone(this.el),this.el=null,f.View.prototype.constructor.call(this,a),this.type="ListItemView",this.render()},render:function(){console.log("rendering "+this.cid+" type: "+this.type),this.triggerMethod("before:render");var a=this.mixinTemplateData(),b=this.compileTemplate(a);this.triggerMethod("render"),this.appendToList(b),this.animateIn()},appendToList:function(a){this.parent&&(this.parent.$el.append(a),this.setEl())},setEl:function(){this.$el=this.parent.$(this.myEl).not("[cid]"),this.$el.attr("cid",this.cid),this.setElement(this.$el)},animateIn:function(){var a=this.settings.animationIn;a&&!c.isEmpty(a)&&("function"==typeof a.callback&&(this.$el.hide(),a.callback.apply(this.$el,a.args)),"string"==typeof a&&this.$el.addClass(a))},destroy:function(){return console.log("destroying "+this.cid+" type: "+this.type),this.unbindEvents(),this.animateOut(),this._isDestroyed=!0,this},emptyEl:function(){var a=this.$el||$(this);a.remove()}}),f.ListView=f.View.extend({constructor:function(a){f.View.prototype.constructor.call(this,a),this.type="ListView",this.listenTo(this.collection,"ready",this.render),this.intialChildBuffer(),this.render()},intialChildBuffer:function(){this._childViews=[]},render:function(){this.destroyChildren(),this.destroyEmptyView(),this.renderEmptyView()||(f.View.prototype.render.call(this),this.collection&&this.collection.models.length&&this.renderChildren())},renderEmptyView:function(){return!(this.collection&&this.collection.length||!this.emptyView)&&(this._emptyView=new this.emptyView({collection:this.collection}),!0)},renderChildren:function(){var a=this;this.triggerMethod("before:render:list:children"),c.each(this.collection.models,function(b){a._childViews.push(a._renderChild(b))}),this.triggerMethod("render:list:children")},_renderChild:function(a){var b=new this.childView({parent:this,model:a});return b},destroyChildren:function(){var a=this;this.triggerMethod("before:destroy:list:child"),this._childViews&&this._childViews.length&&(c.each(this._childViews,function(b){b.destroy&&b.destroy(),a._childViews=c.without(a._childViews,b)}),this.triggerMethod("destroy:list:child"))},destroyEmptyView:function(){this._emptyView&&(this._emptyView.destroy&&this._emptyView.destroy(),this._emptyView=null)}}),f.WrapperView=f.View.extend({constructor:function(a){f.View.prototype.constructor.call(this,a),this.type="WrapperView",this.render()},render:function(){this.destroyChildren(),f.View.prototype.render.call(this),this.renderChildren()},renderChildren:function(){var a=this;c.each(this.childViews,function(b){a.renderChild(b)})},renderChild:function(a){if(a)return new a({collection:this.collection,parent:this})},destroyChildren:function(){this.triggerMethod("destroy:child")}}),f.FormView=f.View.extend({constructor:function(a){f.View.prototype.constructor.call(this,a),this.type="FormView",this._registerMainValidation(),this.model&&this.model.id?this.display():this.edit()},templateSelector:function(a){return c.isObject(this.template)?this.template[a]:this.template},display:function(){var a=c.clone(this.template);this.template=this.templateSelector("display"),this.render(),this.template=a},edit:function(){var a=c.clone(this.template);this.template=this.templateSelector("edit"),this.render(),this.template=a,this.setFormData(this.model),this.triggerMethod("bindControls")},getFormData:function(a){var b={};return invalidform=!1,this.$("input:text[data-field], textarea[data-field], select[data-field], hidden[data-field]").each(function(c,d){!self.validateElement(d)||a?b[$(d).attr("data-field")]=$(d).val()||null:invalidform=!0}),this.$("select[data-field]").each(function(c,d){!self.validateElement(d)||a?b[$(d).attr("data-field")]="true"==$(d).val()||"false"!=$(d).val()&&($(d).val()||null):invalidform=!0}),this.$("input:text[data-field][data-ctrl='datePicker']").each(function(c,d){if(!self.validateElement(d)||a)try{b[$(d).attr("data-field")]=$(d).val()?new Date($(d).val()):null}catch(d){b[$(d).attr("data-field")]=null}else invalidform=!0}),this.$("input:checkbox[data-field]").each(function(c,d){!self.validateElement(d)||a?b[$(d).attr("data-field")]=$(d).prop("checked"):invalidform=!0}),b=1==invalidform?null:b},setFormData:function(a){this.$("input:text[data-field], textarea[data-field], select[data-field], hidden[data-field]").each(function(b,c){self.$(c).val(a.get(self.$(c).attr("data-field")))}),this.$("input:checkbox[data-field]").each(function(b,c){self.$(c).prop("checked",a.get(self.$(c).attr("data-field")))})},validateElement:function(a){if(a){var b=a.currentTarget;this.triggerMethod("clear:error",b);var c=this.validate(this,b);this.triggerMethod("decorate:input",b,c),c&&this.triggerMethod("show:error",c)}return c},validate:function(a,b){var c=a.$(b).attr("data-validate"),d=c&&c.split(" "),e=a.$(b).val();if(d)for(var f=0;f<d.length;f++){var g=this.validations[d[f]].call(a,b,e);if(g)return{validation:d[f],element:b}}return!1},registerValidation:function(a,b){if("string"!=typeof a||"function"!=typeof b)throw Error("registering validation failed, check the validation type or callback, name: "+a);this.validations[a]=b},_registerMainValidation:function(){this.validations=[],this.registerValidation("req",function(a,b){return!b||""==b||null==b}),this.registerValidation("minlen",function(a,b){var c=self.$(a).attr("data-min-len");if(!c||!$.isNumeric(c))throw Error("element doesnt have data-min-len attribute or the attributes is not numeric");return b.length<parseInt(c)}),this.registerValidation("maxlen",function(a,b){var c=self.$(a).attr("data-max-len");if(!self.$(c)||!$.isNumeric(c))throw Error("element doesnt have data-max-len attribute or the attributes is not numeric");return b.length>parseInt(c)}),this.registerValidation("num",function(a,b){if(!b.match(/^\d+$/))return!0}),this.registerValidation("date",function(a,b){try{return Date.parse(b),!1}catch(c){return!0}}),this.registerValidation("datetoday",function(a,b){try{var c=Date.parse(b),d=new Date;return d.setHours(0,0,0,0),c>d}catch(e){return!0}})},save:function(a){a||(a={});var b=this,c=this.getFormData(),d=this.model.isNew();c?(this.triggerMethod("before:save:model"),this.model.set(c),this.model.url()?this.model.save(null,{wait:a.wait,success:function(a,c){b.triggerMethod("save:success",a,c)},error:function(a){b.triggerMethod("save:error",a)}}):d&&this.collection&&!this.model.collection&&this.collection.add(this.model),this.triggerMethod("save:model")):this.triggerMethod("invalidForm")},deleteItem:function(){this.triggerMethod("before:destroy:model"),this.model.url()?this.model.destroy():this.model.collection.remove(),this.triggerMethod("destroy:model")},close:function(){this.destroy()}}),f});
//# sourceMappingURL=brobone.min.js.map